<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Menu Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .allergens-icons {
      font-size: 1.2rem;
      margin-top: 5px;
    }
  </style>
  
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center">–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ø—Å—Ç–∏–µ</h2>

    <form id="menu-form" class="mb-4">
      <!-- input –ø–æ–ª–µ—Ç–∞, –∫–∞–∫—Ç–æ –¥–æ—Å–µ–≥–∞ -->
      <div class="mb-3">
        <label for="name" class="form-label">–ò–º–µ –Ω–∞ —è—Å—Ç–∏–µ—Ç–æ</label>
        <input type="text" class="form-control" id="name" placeholder="–ù–∞–ø—Ä: –ú–ª—è–∫–æ —Å –æ—Ä–∏–∑" required>
      </div>
      <div class="mb-3">
        <label for="ingredients" class="form-label">–°—ä—Å—Ç–∞–≤–∫–∏</label>
        <input type="text" class="form-control" id="ingredients" placeholder="–ù–∞–ø—Ä: –Ø–π—Ü–µ, –∫–∞—à–∫–∞–≤–∞–ª, –º–ª—è–∫–æ">
      </div>
      <div class="mb-3">
        <label for="price" class="form-label">–¶–µ–Ω–∞</label>
        <input type="number" step="0.01" class="form-control" id="price" placeholder="–ù–∞–ø—Ä: 2.50" required>
      </div>
      <div class="mb-3">
        <label for="weight" class="form-label">–ì—Ä–∞–º–∞–∂</label>
        <input type="text" placeholder="–ù–∞–ø—Ä: 200" class="form-control" id="weight">
      </div>
      <div class="mb-3" id="volume-container" style="display: none;">
        <label for="volume" class="form-label">–û–±–µ–º</label>
        <div class="input-group">
          <input type="number" step="0.01" class="form-control" id="volume" placeholder="–Ω–∞–ø—Ä. 0.5">
          <span class="input-group-text" id="volume-unit">–ª.</span>
        </div>
      </div>
      
      
      <div class="mb-3" id="volume-unit-toggle-container" style="display: none;">
        <label class="form-label">–ò–∑–±–æ—Ä –Ω–∞ –º–µ—Ä–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞</label><br>
        <input type="checkbox" id="volume-unit-toggle" class="form-check-input">
        <label for="volume-unit-toggle" class="form-check-label">–ª. / –º–ª.</label>
      </div>
      
      <div class="mb-3">
        <label for="image_file" class="form-label">–ö–∞—á–∏ —Å–Ω–∏–º–∫–∞</label>
        <input type="file" class="form-control" id="image_file" accept="image/*">
        <div class="mb-3" id="current-image-preview" style="display: none;">
          <label class="form-label">–¢–µ–∫—É—â–∞ —Å–Ω–∏–º–∫–∞</label><br>
          <img id="current-image" src="" alt="–°–Ω–∏–º–∫–∞" class="img-thumbnail" style="max-height: 200px;">
        </div>
        
      </div>
      <div class="mb-3">
        <label for="category" class="form-label">–û—Å–Ω–æ–≤–Ω–∞ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="category" class="form-select" required>
          <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
          <option value="zakuski">–ó–∞–∫—É—Å–∫–∏</option>
          <option value="obedno-menu">–û–±–µ–¥–Ω–æ –º–µ–Ω—é</option>
          <option value="specialiteti">–û—Å–Ω–æ–≤–Ω–æ –º–µ–Ω—é</option>
        </select>
      </div>
      <div class="mb-3" id="subcategory-container" style="display: none;">
        <label for="subcategory" class="form-label">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="subcategory" class="form-select">
          <option value="">-- –ò–∑–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
          <option value="salati">–°–∞–ª–∞—Ç–∏</option>
          <option value="predqstiq">–ü—Ä–µ–¥—è—Å—Ç–∏—è</option>
          <option value="osnovni">–û—Å–Ω–æ–≤–Ω–∏ —è—Å—Ç–∏—è</option>
          <option value="ribni">–†–∏–±–Ω–∏ —è—Å—Ç–∏—è</option>
          <option value="skara">–°–∫–∞—Ä–∞</option>
          <option value="deserti">–î–µ—Å–µ—Ä—Ç–∏</option>
          <option value="pite">–•–ª—è–±</option>  
          <option value="napitki">–ù–∞–ø–∏—Ç–∫–∏</option>  
        </select>
      </div>
      <div class="mb-3" id="drink-type-container" style="display: none;">
        <label for="drink_type" class="form-label">–¢–∏–ø –Ω–∞–ø–∏—Ç–∫–∞</label>
        <select id="drink_type" class="form-select">
          <option value="">-- –ò–∑–±–µ—Ä–∏ —Ç–∏–ø --</option>
          <option value="alkoholna">–ê–ª–∫–æ—Ö–æ–ª–Ω–∞</option>
          <option value="bezalkoholna">–ë–µ–∑–∞–ª–∫–æ—Ö–æ–ª–Ω–∞</option>
          <option value="topla">–¢–æ–ø–ª–∏ –Ω–∞–ø–∏—Ç–∫–∏</option>


        </select>
      </div>
      
      
      
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="is_new">
        <label class="form-check-label" for="is_new">–°—É–ø–∏</label>
      </div>
      <div class="mb-3" id="allergens-container">
        <label class="form-label">–ê–ª–µ—Ä–≥–µ–Ω–∏</label>
      </div>
      
      <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏ —è—Å—Ç–∏–µ—Ç–æ</button>
    </form>
    <div class="mb-4">
      <input type="text" id="search-input" class="form-control" placeholder="üîç –¢—ä—Ä—Å–∏ —è—Å—Ç–∏–µ –ø–æ –∏–º–µ...">
    </div>
    <div class="mb-3">
      <div class="btn-group flex-wrap" id="filter-buttons">
        <button class="btn btn-outline-secondary btn-sm" onclick="filterCards('')">–ü–æ–∫–∞–∂–∏ –≤—Å–∏—á–∫–∏</button>
    
        <!-- –ó–∞–∫—É—Å–∫–∏ -->
        <button class="btn btn-outline-primary btn-sm" onclick="filterCards('zakuski')">–ó–∞–∫—É—Å–∫–∏</button>
    
        <!-- –û–±–µ–¥–Ω–æ –º–µ–Ω—é -->
        <button class="btn btn-outline-primary btn-sm" onclick="filterCards('obedno-menu')">–û–±–µ–¥–Ω–æ –º–µ–Ω—é</button>
    
        <!-- –û—Å–Ω–æ–≤–Ω–æ –º–µ–Ω—é (specialiteti) —Å –ø–æ–¥—Å–µ–∫—Ü–∏–∏ -->
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('salati')">–°–∞–ª–∞—Ç–∏</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('predqstiq')">–ü—Ä–µ–¥—è—Å—Ç–∏—è</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('osnovni')">–û—Å–Ω–æ–≤–Ω–∏ —è—Å—Ç–∏—è</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('ribni')">–†–∏–±–Ω–∏ —è—Å—Ç–∏—è</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('deserti')">–î–µ—Å–µ—Ä—Ç–∏</button>
        <button class="btn btn-outline-success btn-sm" onclick="filterCards('pite')">–•–ª—è–±</button>
    

        <button class="btn btn-outline-info btn-sm" onclick="filterCards('napitki')">–ù–∞–ø–∏—Ç–∫–∏</button>
        <button class="btn btn-outline-info btn-sm" onclick="filterCards('bezalkoholna')">–ë–µ–∑–∞–ª–∫–æ—Ö–æ–ª–Ω–∏</button>
        <button class="btn btn-outline-info btn-sm" onclick="filterCards('alkoholna')">–ê–ª–∫–æ—Ö–æ–ª–Ω–∏</button>
        <button class="btn btn-outline-info btn-sm" onclick="filterCards('topla')">–¢–æ–ø–ª–∏ –Ω–∞–ø–∏—Ç–∫–∏</button>

      </div>
    </div>
    <div id="status-message" class="mb-4"></div>
    <div class="row" id="menu-list"></div>
    
  </div>

  
  
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- –í–º—ä–∫–Ω–∏ —Ç–æ–≤–∞ –≤ —Ç–≤–æ—è HTML —Ñ–∞–π–ª, –∑–∞–º–µ–Ω—è–π–∫–∏ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—è <script> -->
    <script>
      let editingItemId = null;
      let currentFilter = '';
      let currentImageUrl = ''; // üü¢ —Ç–æ–≤–∞ –¥–∞ –µ –≥–ª–æ–±–∞–ª–Ω–æ
      const allergenEmojiMap = {
        "–≥–ª—É—Ç–µ–Ω": "üåæ",
        "—Ä–∞–∫–æ–æ–±—Ä–∞–∑–Ω–∏": "ü¶ê",
        "—è–π—Ü–∞": "ü•ö",
        "—Ä–∏–±–∞": "üêü",
        "—Ñ—ä—Å—Ç—ä—Ü–∏": "ü•ú",
        "—Å–æ—è": "üå±",
        "–º–ª—è–∫–æ": "ü•õ",
        "—è–¥–∫–∏": "üå∞",
        "—Ü–µ–ª–∏–Ω–∞": "ü•¨",
        "—Å–∏–Ω–∞–ø": "üåº",
        "—Å—É—Å–∞–º": "‚ö™",
        "—Å–µ—Ä–µ–Ω –¥–∏–æ–∫—Å–∏–¥ –∏ —Å—É–ª—Ñ–∏—Ç–∏": "üß™",
        "–ª—É–ø–∏–Ω–∞": "üåø",
        "–º–µ–∫–æ—Ç–µ–ª–∏": "üêö"
      };
      const supabase = window.supabase.createClient(
        'https://huullvfombogfhmssqrc.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dWxsdmZvbWJvZ2ZobXNzcXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDIyNzAsImV4cCI6MjA2MDQxODI3MH0.7UGhnlUl3FkTQBW9YNTAvbrv5v3GWuRawGlZJAEg5UY'
      );

    
      function getVolumeUnitText() {
        return document.getElementById('volume-unit-toggle').checked ? '–ª.' : '–º–ª.';
      }
    
      function updateVolumeUnitLabel() {
        document.getElementById('volume-unit').textContent = getVolumeUnitText();
      }
    
      document.getElementById('volume-unit-toggle').checked = true;
      updateVolumeUnitLabel();
    
      document.getElementById('category').addEventListener('change', function () {
        const isSpecialiteti = this.value === 'specialiteti';
        document.getElementById('subcategory-container').style.display = isSpecialiteti ? 'block' : 'none';
        if (!isSpecialiteti) document.getElementById('subcategory').value = '';
      });
    
      document.getElementById('subcategory').addEventListener('change', handleSubcategoryChange);
      document.getElementById('volume-unit-toggle').addEventListener('change', updateVolumeUnitLabel);
    
      function handleSubcategoryChange() {
        const subcat = document.getElementById('subcategory').value;
        const isNapitki = subcat === 'napitki';

        document.getElementById('volume-container').style.display = isNapitki ? 'block' : 'none';
        document.getElementById('volume-unit-toggle-container').style.display = isNapitki ? 'block' : 'none';
        document.getElementById('drink-type-container').style.display = isNapitki ? 'block' : 'none';

        document.getElementById('ingredients').parentElement.style.display = isNapitki ? 'none' : '';
        document.getElementById('weight').parentElement.style.display = isNapitki ? 'none' : '';

        if (!isNapitki) {
          document.getElementById('volume').value = '';
          document.getElementById('volume-unit-toggle').checked = true;
          updateVolumeUnitLabel();
          document.getElementById('drink_type').value = '';
        }
      }

      function filterCards(filter) {
        currentFilter = filter; // üü¢ –ó–∞–ø–æ–º–Ω—è–º–µ –∏–∑–±—Ä–∞–Ω–∏—è —Ñ–∏–ª—Ç—ä—Ä

         // üîÅ –û–±–Ω–æ–≤–∏ —Å—Ç–∏–ª–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω–∏—è –±—É—Ç–æ–Ω
        const allButtons = document.querySelectorAll('#filter-buttons button');
        allButtons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = Array.from(allButtons).find(btn =>
          btn.textContent.toLowerCase().includes(filter.toLowerCase()) || filter === ''
        );
        if (activeBtn) activeBtn.classList.add('active');

        // üëá –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ –∫–∞–∫—Ç–æ –¥–æ—Å–µ–≥–∞
        const cards = document.querySelectorAll('#menu-list .card');
        const filterLower = filter.toLowerCase();

        cards.forEach(card => {
          const name = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
          const subcat = card.getAttribute('data-subcat')?.toLowerCase() || '';
          const category = card.getAttribute('data-category')?.toLowerCase() || '';
          const drinkType = card.getAttribute('data-drink-type')?.toLowerCase() || '';

          const matches =
            filterLower === '' ||
            name.includes(filterLower) ||
            subcat.includes(filterLower) ||
            category.includes(filterLower) ||
            drinkType === filterLower;

          card.parentElement.style.display = matches ? 'block' : 'none';
        });

        document.getElementById('menu-list').scrollIntoView({ behavior: 'smooth' });
      }

      function renderCard(item) {
        console.log("üß© –í–∏–∑—É–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —è—Å—Ç–∏–µ:", item.name, "–ê–ª–µ—Ä–≥–µ–Ω–∏:", item.allergens);

        return `
          <div class="card position-relative h-100" data-subcat="${item.subcategory || ''}" data-category="${item.category}" data-drink-type="${item.drink_type || ''}">

            ${item.is_new ? '<div class="position-absolute top-0 end-0 bg-warning px-2 py-1 text-dark fw-bold rounded-start small">–°—É–ø–∏</div>' : ''}
            <img src="${item.image_url || 'https://via.placeholder.com/300'}" class="card-img-top" alt="${item.name}">
            <div class="card-body">
              <h5 class="card-title">${item.name}</h5>
              ${item.subcategory === 'napitki'
              ? `
                <p class="card-text fw-bold">${item.volume || ''} ${item.volume_unit || ''}</p>
                <p class="card-text text-muted fst-italic">
                  ${item.drink_type === 'alkoholna' ? 'üç∑ –ê–ª–∫–æ—Ö–æ–ª–Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞' 
                    : item.drink_type === 'bezalkoholna' ? 'ü•§ –ë–µ–∑–∞–ª–∫–æ—Ö–æ–ª–Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞'
                    : '‚òï –¢–æ–ø–ª–∞ –Ω–∞–ø–∏—Ç–∫–∞'}
                </p>
              `
                : `
                  <p class="card-text">${item.ingredients || ''}</p>
                  <p class="card-text">${item.weight || ''} –≥—Ä.</p>
                  <p class="card-text allergens-icons">
                    ${
                      Array.isArray(item.allergens) && item.allergens.length > 0
                        ? item.allergens.map(a => allergenEmojiMap[a] || '').join(' ')
                        : '<span class="text-muted fst-italic">–ù—è–º–∞ –∞–ª–µ—Ä–≥–µ–Ω–∏</span>'
                    }
                  </p>


                `}
              <p class="card-text fw-bold">${item.price.toFixed(2)} –ª–≤.</p>
              <p class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.category}</p>
              ${item.subcategory ? `<p class="text-muted">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.subcategory}</p>` : ''}
              <button class="btn btn-secondary btn-sm mt-2 me-2" onclick="editItem('${item.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
              ${item.is_visible === false
                ? `<p class="text-danger"><strong>‚ùå –°–∫—Ä–∏—Ç–æ</strong></p>
                   <button class="btn btn-success btn-sm mt-2" onclick="toggleVisibility('${item.id}', true)">–ü–æ–∫–∞–∂–∏ –æ—Ç–Ω–æ–≤–æ</button>`
                : `<button class="btn btn-outline-danger btn-sm mt-2 me-2" onclick="toggleVisibility('${item.id}', false)">–°–∫—Ä–∏–π</button>`
              }
              <button class="btn btn-sm btn-outline-secondary mt-2 me-2" onclick="moveUp('${item.id}')">‚¨ÜÔ∏è</button>
              <button class="btn btn-sm btn-outline-secondary mt-2" onclick="moveDown('${item.id}')">‚¨áÔ∏è</button>

            </div>
          </div>
        `;
      }
      

      async function moveUp(id) {
        await moveItem(id, -1);
      }

      async function moveDown(id) {
        await moveItem(id, 1);
      }

      async function moveItem(id, direction) {
        const { data: currentItem, error } = await supabase.from('menu').select('*').eq('id', id).single();
        if (error) return console.error('–ì—Ä–µ—à–∫–∞:', error);

        const { category, subcategory, drink_type, sort_order } = currentItem;

        let query = supabase.from('menu').select('*')
          .eq('category', category)
          .eq('subcategory', subcategory);

        if (subcategory === 'napitki' && drink_type)
          query = query.eq('drink_type', drink_type);

        const { data: items } = await query.order('sort_order', { ascending: true });

        const index = items.findIndex(item => item.id === id);
        const swapIndex = index + direction;

        if (swapIndex < 0 || swapIndex >= items.length) return;

        const otherItem = items[swapIndex];

        await supabase.from('menu').update({ sort_order: otherItem.sort_order }).eq('id', currentItem.id);
        await supabase.from('menu').update({ sort_order: currentItem.sort_order }).eq('id', otherItem.id);

        await fetchMenu();
        filterCards(currentFilter); // üü¢ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ —Ñ–∏–ª—Ç—ä—Ä–∞ —Å–ª–µ–¥ –º–µ—Å—Ç–µ–Ω–µ
        console.log('–ê–ª–µ—Ä–≥–µ–Ω–∏:', item.allergens);
      }
      const allergensList = [
        "–≥–ª—É—Ç–µ–Ω", "—Ä–∞–∫–æ–æ–±—Ä–∞–∑–Ω–∏", "—è–π—Ü–∞", "—Ä–∏–±–∞", "—Ñ—ä—Å—Ç—ä—Ü–∏", "—Å–æ—è",
        "–º–ª—è–∫–æ", "—è–¥–∫–∏", "—Ü–µ–ª–∏–Ω–∞", "—Å–∏–Ω–∞–ø", "—Å—É—Å–∞–º",
        "—Å–µ—Ä–µ–Ω –¥–∏–æ–∫—Å–∏–¥ –∏ —Å—É–ª—Ñ–∏—Ç–∏", "–ª—É–ø–∏–Ω–∞", "–º–µ–∫–æ—Ç–µ–ª–∏"
      ];

      function renderAllergenCheckboxes(selected = []) {
        const container = document.getElementById('allergens-container');
        container.innerHTML = '<label class="form-label">–ê–ª–µ—Ä–≥–µ–Ω–∏</label><br>';
      
        allergensList.forEach(a => {
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.name = 'allergens';
          checkbox.value = a;
          checkbox.classList.add('form-check-input', 'me-1');
          if (selected.includes(a)) checkbox.checked = true;
        
          const label = document.createElement('label');
          label.classList.add('form-check-label', 'me-3');
          label.appendChild(checkbox);
          label.append(` ${a}`);
        
          container.appendChild(label);
        });
      }

      renderAllergenCheckboxes(); // –∑–∞ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ

    
      document.getElementById('menu-form').addEventListener('submit', async function (e) {
        e.preventDefault();
    
        const name = document.getElementById('name').value;
        const ingredients = document.getElementById('ingredients').value;
        const price = parseFloat(document.getElementById('price').value);
        const category = document.getElementById('category').value;
        const subcategory = document.getElementById('subcategory').value || null;
        const isNapitki = category === 'specialiteti' && subcategory === 'napitki';
        
        const weight = isNapitki ? null : document.getElementById('weight').value;
        const volume = isNapitki ? document.getElementById('volume').value : null;
        const volume_unit = isNapitki ? (document.getElementById('volume-unit-toggle').checked ? '–ª.' : '–º–ª.') : null;
        const is_new = document.getElementById('is_new').checked;
        const file = document.getElementById('image_file').files[0];
        if (category === 'specialiteti' && (!subcategory || subcategory === '')) {
           return alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è.');
         }
        const drink_type = isNapitki ? document.getElementById('drink_type').value : null;
        let sort_order = 1;

        let query = supabase
          .from('menu')
          .select('sort_order')
          .eq('category', category)
          .eq('subcategory', subcategory);

        if (subcategory === 'napitki' && drink_type) {
          query = query.eq('drink_type', drink_type);
        }

        const { data: existingData, error: existingError } = await query;

        if (!existingError && existingData.length > 0) {
          const maxOrder = Math.max(...existingData.map(item => item.sort_order || 0));
          sort_order = maxOrder + 1;
        }



        let image_url = '';
        if (file) {
          const filePath = `${Date.now()}_${file.name}`;
          const { error: uploadError } = await supabase.storage.from('menu-images').upload(filePath, file);
          if (uploadError) return alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ: ' + uploadError.message);
          const { data: urlData } = supabase.storage.from('menu-images').getPublicUrl(filePath);
          image_url = urlData.publicUrl;
        } else if (editingItemId && currentImageUrl) {
          image_url = currentImageUrl; // üü¢ –∏–∑–ø–æ–ª–∑–≤–∞–º–µ —Å—Ç–∞—Ä–∞—Ç–∞ —Å–Ω–∏–º–∫–∞
        }

    
        
         // üî¥ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–∫–æ –µ –Ω–∞–ø–∏—Ç–∫–∞, –æ–±–µ–º—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω
         if (isNapitki && (!volume || volume === '')) {
           return alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –æ–±–µ–º –Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞—Ç–∞.');
         }
         if (isNapitki && (!drink_type || drink_type === '')) {
          return alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ —Ç–∏–ø –Ω–∞–ø–∏—Ç–∫–∞.');
        }
        const selectedAllergens = Array.from(
          document.querySelectorAll('input[name="allergens"]:checked')
        ).map(cb => cb.value);

        const dishData = {
          name,
          ingredients: isNapitki ? null : ingredients,
          weight,
          volume,
          volume_unit,
          drink_type, // üëà –¥–æ–±–∞–≤–∏ —Ç–æ–≤–∞ —Ç—É–∫
          price,
          category,
          subcategory,
          is_new,
          is_visible: true,
          sort_order,
          allergens: selectedAllergens,
        };
        console.log("üì§ –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —è—Å—Ç–∏–µ:", dishData);

    
        if (image_url) dishData.image_url = image_url;
    
        const status = document.getElementById('status-message');
    
        if (editingItemId) {
          const { error } = await supabase.from('menu').update(dishData).eq('id', editingItemId);
          if (error) return (status.innerHTML = '<div class="alert alert-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ü–∏—è</div>');
          status.innerHTML = '<div class="alert alert-success">‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!</div>';
        } else {
          if (is_new) {
            let reorderQuery = supabase
              .from('menu')
              .select('id, sort_order')
              .eq('category', category)
              .eq('subcategory', subcategory)
              .eq('is_visible', true);
          
            if (subcategory === 'napitki' && drink_type) {
              reorderQuery = reorderQuery.eq('drink_type', drink_type);
            }
          
            const { data: others, error: reorderError } = await reorderQuery;
          
            if (!reorderError && others.length > 0) {
              for (const item of others) {
                await supabase
                  .from('menu')
                  .update({ sort_order: item.sort_order + 1 })
                  .eq('id', item.id);
              }
            }
          
            sort_order = 1; // –ù–æ–≤–æ—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–∞–π-–≤–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
            dishData.sort_order = 1; // –æ–±–Ω–æ–≤–∏ –∏ –≤ –æ–±–µ–∫—Ç–∞
          }
        
          const { error } = await supabase.from('menu').insert([dishData]);
          if (error) return (status.innerHTML = '<div class="alert alert-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ</div>');
          status.innerHTML = '<div class="alert alert-success">‚úÖ –î–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</div>';
        }

    
        this.reset();
        editingItemId = null;
        document.getElementById('subcategory-container').style.display = 'none';
        document.getElementById('volume-container').style.display = 'none';
        document.getElementById('volume-unit-toggle-container').style.display = 'none';
        // –ü–æ–∫–∞–∑–≤–∞–º–µ –æ–±—Ä–∞—Ç–Ω–æ —Å—ä—Å—Ç–∞–≤–∫–∏ –∏ –≥—Ä–∞–º–∞–∂
        document.getElementById('ingredients').parentElement.style.display = '';
        document.getElementById('weight').parentElement.style.display = '';
        document.getElementById('volume-unit-toggle').checked = true;
        updateVolumeUnitLabel();
        document.querySelector('#menu-form button[type="submit"]').textContent = '–î–æ–±–∞–≤–∏ —è—Å—Ç–∏–µ—Ç–æ';
        fetchMenu();

      });
    
      window.editItem = async function (id) {
        currentImageUrl = '';
        

        const { data, error } = await supabase.from('menu').select('*').eq('id', id).single();
        currentImageUrl = data.image_url || '';
        document.getElementById('current-image').src = currentImageUrl;
        document.getElementById('current-image-preview').style.display = currentImageUrl ? 'block' : 'none';
        if (error) return alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —è—Å—Ç–∏–µ—Ç–æ.');


        renderAllergenCheckboxes(data.allergens || []);

        if (data.subcategory === 'napitki') {
          document.getElementById('volume').value = data.volume || '';
          document.getElementById('volume-unit-toggle').checked = data.volume_unit === '–ª.';
          updateVolumeUnitLabel();
          document.getElementById('drink_type').value = data.drink_type || '';
        }

        editingItemId = id;
        document.getElementById('name').value = data.name;
        document.getElementById('ingredients').value = data.ingredients || '';
        document.getElementById('price').value = data.price.toFixed(2);
        document.getElementById('weight').value = data.weight || '';
        document.getElementById('category').value = data.category;
        document.getElementById('is_new').checked = data.is_new;
        document.getElementById('drink_type').value = data.drink_type || '';

        document.getElementById('category').dispatchEvent(new Event('change'));
        if (data.category === 'specialiteti') {
          document.getElementById('subcategory').value = data.subcategory || '';
          document.getElementById('subcategory').dispatchEvent(new Event('change'));
        }
    
        if (data.subcategory === 'napitki') {
          document.getElementById('volume').value = data.volume || '';
          document.getElementById('volume-unit-toggle').checked = data.volume_unit === '–ª.';
          updateVolumeUnitLabel();
        }
    
        document.querySelector('#menu-form button[type="submit"]').textContent = '–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    
      async function toggleVisibility(id, show) {
        await supabase.from('menu').update({ is_visible: show }).eq('id', id);
        fetchMenu();
      }
    
      async function fetchMenu() {
        const { data, error } = await supabase.from('menu').select('*');
        const container = document.getElementById('menu-list');
        container.innerHTML = '';
        if (error) {
          console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:', error);
          return;
        }

        data.sort((a, b) => a.sort_order - b.sort_order);

        data.forEach(item => {
          console.log("üì• –ó–∞—Ä–µ–¥–µ–Ω–∏ —è—Å—Ç–∏—è:", data);

          const cardWrapper = document.createElement('div');
          cardWrapper.className = 'col-md-4 mb-4';
          cardWrapper.id = `card-${item.id}`;
          cardWrapper.innerHTML = renderCard(item);
          container.appendChild(cardWrapper);
        });
      }

    
      fetchMenu();


      document.getElementById('search-input').addEventListener('input', function () {
        const query = this.value.toLowerCase();
        const allCards = document.querySelectorAll('#menu-list .card');

        allCards.forEach(card => {
          const title = card.querySelector('.card-title').textContent.toLowerCase();
          card.parentElement.style.display = title.includes(query) ? 'block' : 'none';
        });
      });

    </script>
    
    
    

  
</body>
</html>
