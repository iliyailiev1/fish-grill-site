<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Menu Editor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4 text-center">–î–æ–±–∞–≤—è–Ω–µ –Ω–∞ –Ø—Å—Ç–∏–µ</h2>

    <form id="menu-form" class="mb-4">
      <!-- input –ø–æ–ª–µ—Ç–∞, –∫–∞–∫—Ç–æ –¥–æ—Å–µ–≥–∞ -->
      <div class="mb-3">
        <label for="name" class="form-label">–ò–º–µ –Ω–∞ —è—Å—Ç–∏–µ—Ç–æ</label>
        <input type="text" class="form-control" id="name" required>
      </div>
      <div class="mb-3">
        <label for="ingredients" class="form-label">–°—ä—Å—Ç–∞–≤–∫–∏</label>
        <input type="text" class="form-control" id="ingredients">
      </div>
      <div class="mb-3">
        <label for="price" class="form-label">–¶–µ–Ω–∞</label>
        <input type="number" step="0.01" class="form-control" id="price" required>
      </div>
      <div class="mb-3">
        <label for="weight" class="form-label">–ì—Ä–∞–º–∞–∂</label>
        <input type="text" class="form-control" id="weight">
      </div>
      <div class="mb-3" id="volume-container" style="display: none;">
        <label for="volume" class="form-label">–û–±–µ–º</label>
        <div class="input-group">
          <input type="number" step="0.01" class="form-control" id="volume" placeholder="–Ω–∞–ø—Ä. 0.5">
          <span class="input-group-text" id="volume-unit">–ª.</span>
        </div>
      </div>
      
      
      <div class="mb-3" id="volume-unit-toggle-container" style="display: none;">
        <label class="form-label">–ò–∑–±–æ—Ä –Ω–∞ –º–µ—Ä–Ω–∞ –µ–¥–∏–Ω–∏—Ü–∞</label><br>
        <input type="checkbox" id="volume-unit-toggle" class="form-check-input">
        <label for="volume-unit-toggle" class="form-check-label">–ª. / –º–ª.</label>
      </div>
      
      <div class="mb-3">
        <label for="image_file" class="form-label">–ö–∞—á–∏ —Å–Ω–∏–º–∫–∞</label>
        <input type="file" class="form-control" id="image_file" accept="image/*" required>
      </div>
      <div class="mb-3">
        <label for="category" class="form-label">–û—Å–Ω–æ–≤–Ω–∞ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="category" class="form-select" required>
          <option value="">-- –ò–∑–±–µ—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
          <option value="zakuski">–ó–∞–∫—É—Å–∫–∏</option>
          <option value="obedno-menu">–û–±–µ–¥–Ω–æ –º–µ–Ω—é</option>
          <option value="specialiteti">–û—Å–Ω–æ–≤–Ω–æ –º–µ–Ω—é</option>
        </select>
      </div>
      <div class="mb-3" id="subcategory-container" style="display: none;">
        <label for="subcategory" class="form-label">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="subcategory" class="form-select">
          <option value="">-- –ò–∑–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è --</option>
          <option value="supi">–°—É–ø–∏</option>
          <option value="salati">–°–∞–ª–∞—Ç–∏</option>
          <option value="predqstiq">–ü—Ä–µ–¥—è—Å—Ç–∏—è</option>
          <option value="osnovni">–û—Å–Ω–æ–≤–Ω–∏ —è—Å—Ç–∏—è</option>
          <option value="ribni">–†–∏–±–Ω–∏ —è—Å—Ç–∏—è</option>
          <option value="skara">–°–∫–∞—Ä–∞</option>
          <option value="deserti">–î–µ—Å–µ—Ä—Ç–∏</option>
          <option value="pite">–•–ª—è–±</option>  
          <option value="napitki">–ù–∞–ø–∏—Ç–∫–∏</option>  
        </select>
      </div>
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="is_new">
        <label class="form-check-label" for="is_new">–ù–æ–≤–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</label>
      </div>
      <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏ —è—Å—Ç–∏–µ—Ç–æ</button>
    </form>

    <div id="status-message" class="mb-4"></div>
    <div class="row" id="menu-list"></div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- –í–º—ä–∫–Ω–∏ —Ç–æ–≤–∞ –≤ —Ç–≤–æ—è HTML —Ñ–∞–π–ª, –∑–∞–º–µ–Ω—è–π–∫–∏ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—â–∏—è <script> -->
    <script>
      const supabase = window.supabase.createClient(
        'https://huullvfombogfhmssqrc.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1dWxsdmZvbWJvZ2ZobXNzcXJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDIyNzAsImV4cCI6MjA2MDQxODI3MH0.7UGhnlUl3FkTQBW9YNTAvbrv5v3GWuRawGlZJAEg5UY'
      );
    
      let editingItemId = null;
    
      function getVolumeUnitText() {
        return document.getElementById('volume-unit-toggle').checked ? '–ª.' : '–º–ª.';
      }
    
      function updateVolumeUnitLabel() {
        document.getElementById('volume-unit').textContent = getVolumeUnitText();
      }
    
      document.getElementById('volume-unit-toggle').checked = true;
      updateVolumeUnitLabel();
    
      document.getElementById('category').addEventListener('change', function () {
        const isSpecialiteti = this.value === 'specialiteti';
        document.getElementById('subcategory-container').style.display = isSpecialiteti ? 'block' : 'none';
        if (!isSpecialiteti) document.getElementById('subcategory').value = '';
      });
    
      document.getElementById('subcategory').addEventListener('change', handleSubcategoryChange);
      document.getElementById('volume-unit-toggle').addEventListener('change', updateVolumeUnitLabel);
    
      function handleSubcategoryChange() {
        const subcat = document.getElementById('subcategory').value;
        const isNapitki = subcat === 'napitki';


        document.getElementById('volume-container').style.display = isNapitki ? 'block' : 'none';
        document.getElementById('volume-unit-toggle-container').style.display = isNapitki ? 'block' : 'none';
        document.getElementById('ingredients').parentElement.style.display = isNapitki ? 'none' : '';
        document.getElementById('weight').parentElement.style.display = isNapitki ? 'none' : '';

        // –ü–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ –ª–∏—Ç—Ä–∏
        if (!isNapitki) {
          document.getElementById('volume').value = '';
          document.getElementById('volume-unit-toggle').checked = true;
          updateVolumeUnitLabel();
        }
      }


    
      function renderCard(item) {
        return `
          <div class="card position-relative h-100">
            ${item.is_new ? '<div class="position-absolute top-0 end-0 bg-warning px-2 py-1 text-dark fw-bold rounded-start small">–ù–û–í–û!</div>' : ''}
            <img src="${item.image_url || 'https://via.placeholder.com/300'}" class="card-img-top" alt="${item.name}">
            <div class="card-body">
              <h5 class="card-title">${item.name}</h5>
              ${item.subcategory === 'napitki'
                ? `<p class="card-text fw-bold">${item.volume || ''} ${item.volume_unit || ''}</p>`
                : `
                  <p class="card-text">${item.ingredients || ''}</p>
                  <p class="card-text">${item.weight || ''} –≥—Ä.</p>
                `}
              <p class="card-text fw-bold">${item.price.toFixed(2)} –ª–≤.</p>
              <p class="text-muted">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.category}</p>
              ${item.subcategory ? `<p class="text-muted">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${item.subcategory}</p>` : ''}
              <button class="btn btn-secondary btn-sm mt-2 me-2" onclick="editItem('${item.id}')">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
              ${item.is_visible === false
                ? `<p class="text-danger"><strong>‚ùå –°–∫—Ä–∏—Ç–æ</strong></p>
                   <button class="btn btn-success btn-sm mt-2" onclick="toggleVisibility('${item.id}', true)">–ü–æ–∫–∞–∂–∏ –æ—Ç–Ω–æ–≤–æ</button>`
                : `<button class="btn btn-outline-danger btn-sm mt-2" onclick="toggleVisibility('${item.id}', false)">–°–∫—Ä–∏–π</button>`}
            </div>
          </div>
        `;
      }
    
      document.getElementById('menu-form').addEventListener('submit', async function (e) {
        e.preventDefault();
    
        const name = document.getElementById('name').value;
        const ingredients = document.getElementById('ingredients').value;
        const price = parseFloat(document.getElementById('price').value);
        const category = document.getElementById('category').value;
        const subcategory = document.getElementById('subcategory').value || null;
        const isNapitki = category === 'specialiteti' && subcategory === 'napitki';

        const weight = isNapitki ? null : document.getElementById('weight').value;
        const volume = isNapitki ? document.getElementById('volume').value : null;
        const volume_unit = isNapitki ? (document.getElementById('volume-unit-toggle').checked ? '–ª.' : '–º–ª.') : null;
        const is_new = document.getElementById('is_new').checked;
        const file = document.getElementById('image_file').files[0];
        if (category === 'specialiteti' && (!subcategory || subcategory === '')) {
           return alert('–ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è.');
         }
       
         // üî¥ 3. –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–∫–æ –µ –Ω–∞–ø–∏—Ç–∫–∞, –æ–±–µ–º—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–µ–Ω
         if (isNapitki && (!volume || volume === '')) {
           return alert('–ú–æ–ª—è, –≤—ä–≤–µ–¥–∏ –æ–±–µ–º –Ω–∞ –Ω–∞–ø–∏—Ç–∫–∞—Ç–∞.');
         }
        let image_url = '';
        if (file) {
          const filePath = `${Date.now()}_${file.name}`;
          const { error: uploadError } = await supabase.storage.from('menu-images').upload(filePath, file);
          if (uploadError) return alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ: ' + uploadError.message);
          const { data: urlData } = supabase.storage.from('menu-images').getPublicUrl(filePath);
          image_url = urlData.publicUrl;
        }
    
        const dishData = {
          name,
          ingredients: isNapitki ? null : ingredients,
          weight,
          volume,
          volume_unit,
          price,
          category,
          subcategory,
          is_new,
          is_visible: true,
        };
    
        if (image_url) dishData.image_url = image_url;
    
        const status = document.getElementById('status-message');
    
        if (editingItemId) {
          const { error } = await supabase.from('menu').update(dishData).eq('id', editingItemId);
          if (error) return (status.innerHTML = '<div class="alert alert-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ü–∏—è</div>');
          status.innerHTML = '<div class="alert alert-success">‚úÖ –ü—Ä–æ–º–µ–Ω–∏—Ç–µ —Å–∞ –∑–∞–ø–∞–∑–µ–Ω–∏!</div>';
        } else {
          const { error } = await supabase.from('menu').insert([dishData]);
          if (error) return (status.innerHTML = '<div class="alert alert-danger">–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤—è–Ω–µ</div>');
          status.innerHTML = '<div class="alert alert-success">‚úÖ –î–æ–±–∞–≤–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</div>';
        }
    
        this.reset();
        editingItemId = null;
        document.getElementById('subcategory-container').style.display = 'none';
        document.getElementById('volume-container').style.display = 'none';
        document.getElementById('volume-unit-toggle-container').style.display = 'none';
        // –ü–æ–∫–∞–∑–≤–∞–º–µ –æ–±—Ä–∞—Ç–Ω–æ —Å—ä—Å—Ç–∞–≤–∫–∏ –∏ –≥—Ä–∞–º–∞–∂
        document.getElementById('ingredients').parentElement.style.display = '';
        document.getElementById('weight').parentElement.style.display = '';
        document.getElementById('volume-unit-toggle').checked = true;
        updateVolumeUnitLabel();
        document.querySelector('#menu-form button[type="submit"]').textContent = '–î–æ–±–∞–≤–∏ —è—Å—Ç–∏–µ—Ç–æ';
        fetchMenu();

      });
    
      window.editItem = async function (id) {
        const { data, error } = await supabase.from('menu').select('*').eq('id', id).single();
        if (error) return alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —è—Å—Ç–∏–µ—Ç–æ.');
    
        editingItemId = id;
        document.getElementById('name').value = data.name;
        document.getElementById('ingredients').value = data.ingredients || '';
        document.getElementById('price').value = data.price.toFixed(2);
        document.getElementById('weight').value = data.weight || '';
        document.getElementById('category').value = data.category;
        document.getElementById('is_new').checked = data.is_new;
    
        document.getElementById('category').dispatchEvent(new Event('change'));
        if (data.category === 'specialiteti') {
          document.getElementById('subcategory').value = data.subcategory || '';
          document.getElementById('subcategory').dispatchEvent(new Event('change'));
        }
    
        if (data.subcategory === 'napitki') {
          document.getElementById('volume').value = data.volume || '';
          document.getElementById('volume-unit-toggle').checked = data.volume_unit === '–ª.';
          updateVolumeUnitLabel();
        }
    
        document.querySelector('#menu-form button[type="submit"]').textContent = '–ó–∞–ø–∞–∑–∏ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    
      async function toggleVisibility(id, show) {
        await supabase.from('menu').update({ is_visible: show }).eq('id', id);
        fetchMenu();
      }
    
      async function fetchMenu() {
        const { data, error } = await supabase.from('menu').select('*');
        const container = document.getElementById('menu-list');
        container.innerHTML = '';
        if (error) return console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ:', error);
        data.sort((a, b) => b.is_new - a.is_new);
        data.forEach(item => {
          const cardWrapper = document.createElement('div');
          cardWrapper.className = 'col-md-4 mb-4';
          cardWrapper.id = `card-${item.id}`;
          cardWrapper.innerHTML = renderCard(item);
          container.appendChild(cardWrapper);
        });
      }
    
      fetchMenu();
    </script>
    
    
    

  
</body>
</html>
